{% extends "base.html" %}
{% block content %}

      <!-- Jumbotron -->
        <div class="row">
      <div class="col-lg-8 col-md-8 ">
      
      <div class="input-group input-group-md">
  
  <input id="search" type="text" class="form-control col-lg-12 col-md-12" placeholder="{{query}}" aria-describedby="sizing-addon1"
  onkeydown="if (event.keyCode==13) { search();}">
   <span class="input-group-btn">
        <button class="btn btn-primary" type="button" onclick="search()" style="position:relative;top:-2px;">Search</button>
      </span>
</div>
          
        </div>
      </div>

      <div class="row">
      <div class="col-lg-12 col-md-12">
        <h2>Search results for {{query}}</h2>
      </div>
    </div>
    <div style="display:none;">
      {{current_user.id}}
    </div>
    <hr>
   <div class="row">
      <div class="col-lg-12 col-md-12">
        
   
{% for result in results|batch(2) %}
<div class="row clearfix">

  {% for item in result %}
              <div class="col-lg-6 col-md-6 col-sm-12" style="margin-bottom:3px;">
    

            
                <div class="row clearfix result" >
                  <div class="col-lg-5 col-md-5 col-sm-5">
                    <div class="col-lg-12 col-md-12 col-sm-12">
                      <a href="/tutor?id={{item['_id']}}"><b class="tutors" id="{{item['_id']}}">{{item['name'].title()}}</b></a>
                    </div>
                    <div class="col-lg-12 col-md-12 col-sm-12 text-muted">
                      {% if item['venue'] is equalto 'both' %}
                      Teaches at both students' home and center
                      {% else %}
                      Teaches at {{item['venue']}}
                      {% endif %}
                    </div>
                    {% if current_user.id %}
                    <div class="col-lg-12 col-md-12 col-sm-12 text-muted associations">
                      
                      <button id="associate_{{item['_id']}}" type="button" class="btn btn-primary btn-sm" onclick="associate_tutor('{{item['_id']}}','{{current_user.fb_id}}')" 
                      {% if item['_id'] not in student_tutor_assoc %}
                      style="display:;"
                      {% else %}
                      style="display:none;"
                      {% endif %}
                      >I studied under this teacher</button>
                      
                      <span id="disassociate_{{item['_id']}}"
                       {% if item['_id'] in student_tutor_assoc %}
                      style="display:;"
                      {% else %}
                      style="display:none;"
                      {% endif %}
                     >
                      

                      
                      You studied under this tutor 
                      <button type="button" class="btn btn-warning btn-sm" onclick="disassociate_tutor('{{item['_id']}}','{{current_user.fb_id}}')">No</button>
                    </span>
                   
                   
                     </div>
                    {% endif %}
                     <div class="col-lg-12 col-md-12 col-sm-12 text-muted associations" style="display:none;color:#5cb85c" id="friend_{{item['_id']}}">

                     </div>
                  </div>
                  <div class="col-lg-7 col-md-7 col-sm-7">

                    <div class="col-lg-12 col-md-12 col-sm-12">
                      <span class="glyphicon glyphicon-phone" aria-hidden="true"></span> {{item['contact_number']|join(',')}}
                    </div>
                    <div class="col-lg-12 col-md-12 col-sm-12">
                      <span class="glyphicon glyphicon-envelope" aria-hidden="true"></span> {{item['email'].title()}}
                    </div>
                    <div class="col-lg-12 col-md-12 col-sm-12">
                      <span class="glyphicon glyphicon-map-marker" style="color:#2780e3" aria-hidden="true"></span> {{item['geographical_location'].title()}}
                    </div>
                  </div>
                </div>
            
 
         </div>
         {% endfor %}

</div> 
<br>
              {% endfor %}
              </div>  
            </div>

    
      

      <!-- Example row of columns -->
{% endblock %}

{% block javascript %}

<script>
$('.result').hover(function(){
  $(this).css('background-color','#eee');
},function(){
  $(this).css('background-color','white');
});
</script>   

<script>     
function options(subject)
{
  return ['check'];
  $.ajax({
  type: "GET",
  url: "/options?subject="+subject,
  
  
  success: function(data)
  {
    return data;
    
  },
  fail: function()
  {
    
    
  }
}).done(function( msg ) {
 // document.getElementById("user_tips").value="";
  //alert("Thanks for helping us improve!");
});
}

var subjects = new Bloodhound({
  datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
  queryTokenizer: Bloodhound.tokenizers.whitespace,
  
  remote: {
    url: '/options?subject=%QUERY',
    wildcard: '%QUERY'
  },
   prefetch : {
    url: '/options?subject='
   
  }
});

$('.input-group #search').typeahead({
  hint: true,
  highlight: true,
  minLength: 1
}, {
  name: 'subjects',
  display: 'value',
  source: subjects
});

function associate_tutor(tutor_id,student_id){

  data={};
  data['tutor_id']=tutor_id;
  data['student_id']=student_id;
  jQuery.ajax({
    url: '/associate_student_tutor',
    data: data,
    type: 'POST',
    success: function(data)
    {
      if(data['result']=='success')
      {
        $('#associate_'+tutor_id).css('display','none');
        $('#disassociate_'+tutor_id).css('display','');
      }
    }

});
}

function disassociate_tutor(tutor_id,student_id){

  data={};
  data['tutor_id']=tutor_id;
  data['student_id']=student_id;
  jQuery.ajax({
    url: '/disassociate_student_tutor',
    data: data,
    type: 'POST',
    success: function(data)
    {
      if(data['result']=='success')
      {
        $('#disassociate_'+tutor_id).css('display','none');
        $('#associate_'+tutor_id).css('display','');
      }
    }

});
}

function tutor(id){
  window.location='tutor?id='+id;
}

function search()
    {
        var name=document.getElementById("search");
        if(name==null || name.value.trim()=="")
          return;
        window.location='search?subject='+encodeURIComponent(name.value.trim());
    }


function custom_logic(login_status)
{
  //alert(login_status);
  utility(login_status);
}

function utility(login_status){

  
  if(login_status!='connected'){
    $('.associations').each(function(){
      $(this).css('display','none');
    });
  }
  else{
    friend_tutor();
  }

}


function friend_tutor()
{
  //alert('friend_tutor');
  var tutors=[]
  console.log($('.tutors').size());
  $('.tutors').each(function(){
    tutors.push($(this).attr('id'));
  });
  var friends=[]
   FB.api('/me/friends', function(response) {
    console.log(response);
    var ind=0;
    for(ind=0;ind<response['data'].length;ind++)
    {
      friends.push(response['data'][ind]['id']);
    }

    data={}
   data['tutors']=tutors;
   data['friends']=friends;
   console.log(data);
   jQuery.ajax({
    url: '/friend_tutor',
    data: data,
    type: 'POST',
    success: function(data)
    {
      if(data['result']=='success')
      {
        var ind=0;
        for(ind=0;ind<data['friend_tutor'].length;ind++)
        {
          $('#friend_'+data['friend_tutor'][ind]).text('Your friend has studied under this tutor');
          $('#friend_'+data['friend_tutor'][ind]).css('display','');
        }
      }
    }

});
  });
   

}



</script>  
{% endblock %}



