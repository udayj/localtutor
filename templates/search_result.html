{% extends "base2.html" %}
{% block css %}
<link rel="stylesheet" href="/static/stylesheets/pages/page_search_inner.css">
{% endblock %}

{% block content %}

<!--div class="breadcrumbs breadcrumbs-dark">
        <div class="container">
            <h1 class="pull-left">Search Results</h1>
           
        </div>
    </div-->
    <div class="container">
  <div class="search-block-v2">
        <div class="container" style="margin-top:-30px;margin-bottom:-20px;">
            <div class="col-md-6 ">
               <h3>Search results for {{query}}</h3>
                <div class="input-group">

                    <input id="search" type="text" class="form-control" placeholder="{{query}}" value="{{query}}" onkeydown="if (event.keyCode==13) { search();}" value="{{query}}">
                    <span class="input-group-btn">
                        <button class="btn-u" type="button" style="margin-top:-0.4em;" onclick="search()"><i class="fa fa-search"></i></button>
                    </span>
                </div>
                 
            </div>
        </div>
    </div>
  </div>
      <!-- Jumbotron -->
        <!--div class="row">
      <div class="col-lg-8 col-md-8 ">
      
      <div class="input-group input-group-md">
  
  <input id="search" type="text" class="form-control col-lg-12 col-md-12" placeholder="{{query}}" aria-describedby="sizing-addon1"
  >
   <span class="input-group-btn">
        <button class="btn btn-primary" type="button" onclick="search()" style="position:relative;top:-2px;">Search</button>
      </span>
</div>
          
        </div>
      </div-->

      <!--div class="row">
      <div class="col-lg-12 col-md-12">
        <h2>Search results for {{query}}</h2>
      </div>
    </div-->
    <div style="display:none;">
      {{current_user.id}}
    </div>

    <div class="container s-results margin-bottom-50">
        <div class="row">
          <button type="button" class="btn-u visible-xs" data-toggle="collapse" data-target="#filter-options" style="margin-left:1em;margin-bottom:0.5em;" onclick="toggler()">
            <i class="fa fa-sliders"> Filters </i>
          </button>
            <div id="filter-options" class="col-md-2 related-search hidden-xs">
                <div class="row" style="margin-left:0.1em";>
                   <div style="display:none;">
            <form id='filter_form' type="hidden" action='/search?subject={{query}}' method='POST'>
            </form>
          </div>

          {% if filter_results %}

            {% if areas|length > 0 %}
            <h3>Filter by Area</h3>
              <div id="area_outer" class="col-md-12 col-sm-4 sky-form" style="border:0px;max-height:300px;overflow-y:scroll;margin-bottom:30px;">
                
                <ul class="list-unstyled" >
                  
              {% for area in areas %}

              <li><label class="checkbox"><input class="area_checkbox" type="checkbox" onclick="get_filtered_results_pre()" name="{{area[0]}}"
              {% if area[1] %}
              checked
              {% endif %}
              ><i></i>{{area[0].title()}}</label></li>
              {% endfor %}
           
            </ul>

            </div>
            {% endif %}
            
            {% if subjects|length > 0 %}
            <h3>Filter by Subject</h3>
            <div id="subject_outer" class="col-md-12 col-sm-4 sky-form" style="border:0px;max-height:300px;overflow-y:scroll;margin-bottom:30px;">
              
              <ul class="list-unstyled">
              {% for subject in subjects %}
              <li><label class="checkbox"><input class="subject_checkbox" type="checkbox" onclick="get_filtered_results_pre()" name="{{subject[0]}}"
              {% if subject[1] %}
              checked
              {% endif %}
              ><i></i>{{subject[0].title()}}</label></li>
              {% endfor %}
            </div>
            {% endif %}

             {% if venue|length > 0 %}
            <h3>Filter by Venue</h3>
              <div id="venue_outer" class="col-md-12 col-sm-4 sky-form" style="border:0px;max-height:300px;overflow-y:scroll;margin-bottom:30px;">
                
                <ul class="list-unstyled" >
                  
              {% for v in venue %}

              <li><label class="checkbox"><input class="venue_checkbox" type="checkbox" onclick="get_filtered_results_pre()" name="{{v[0]}}"
              {% if v[1] %}
              checked
              {% endif %}
              ><i></i>{{v[0]}}</label></li>
              {% endfor %}
           
            </ul>

            </div>
            {% endif %}

                    

                   
                
                {% else %}
                <h3>No Filters</h3>
                {% endif %}
                </div>
            </div><!--/col-md-2-->
            <div class="col-md-10">
                <span class="results-number" style="margin-bottom:30px;">{{total}} results</span>
                <!-- Begin Inner Results -->
                {% for result in results | batch(2) %}
                <div class="inner-results row clearfix">
                  {% for item in result %}
                  <script>
                  buffer["{{item['_id']}}"]=0;
                  </script>

                <div class=" col-lg-6 col-md-6 col-sm-12" style="margin-bottom:20px;">
                  <h3><a class="tutors" href="/tutor?id={{item['_id']}}" id="{{item['_id']}}">{{item['name'].title()}}</a></h3>
                    
                    <ul class="list-inline up-ul">
                        <li>
                           {% if item['area'] is equalto 'online' %}
                      This is an online course available at {{item['venue']}}
                      {% else %}

                      {% if item['venue'] is equalto 'both' %}
                      Teaches at both students' home and center
                      
                      {% else %}
                      Teaches at {{item['venue']}}
                      {% endif %}
                      {% endif %}
                        </li>
                        <li class="btn-group">
                            <button data-toggle="dropdown" class="btn btn-default dropdown-toggle" type="button">
                                Subjects Covered<i class="fa fa-caret-down margin-left-5"></i>
                                <span class="sr-only">Toggle Dropdown</span>
                            </button>
                            <ul role="menu" class="dropdown-menu">
                              {% for subject in item['subject'] %}

                                <li><a href="#">{{subject.title()}}</a></li>
                                {% endfor %}
                            </ul>
                        </li>
                        
                    </ul>
                    <p>
                      {% if item['area'] is equalto 'online' %}
                     
                      
                      {% else %}
                       <span class="glyphicon glyphicon-phone" aria-hidden="true"></span>
                       {{item['contact_number']|join(',')}}
                       <br>
                       {% endif %}

                        {% if item['area'] is equalto 'online' %}
                       <a href="{{item['geographical_location']}}">Online course link</a>
                       {% else %}
                       {{item['geographical_location'].title()}}
                       {% endif %}
                    </p>
                    
                    <ul id="like_section_{{item['_id']}}" class="list-inline down-ul"
                     {% if item['likes'] > 0 %}
                    style="display:;"
                    {% else %}
                    style="display:none;"
                    {% endif %}
                    >
                      <li>
                         {% if item['likes'] == 0 %}
                    <span id="likes_{{item['_id']}}">
                     
                      </span>
                    {% endif %}

                    {% if item['likes'] > 2 %}
                    <span id="likes_{{item['_id']}}">
                      {% if item['_id'] in student_tutor_like %}
                      You and {{item['likes'] - 1}} people like this teacher 
                      {% else %}
                      {{item['likes']}} people like this teacher 
                      {% endif %}
                      </span>
                    {% endif %}
                    {% if item['likes'] == 2 %}
                    <span id="likes_{{item['_id']}}">
                      {% if item['_id'] in student_tutor_like %}
                      You and {{item['likes'] -1}} person like this teacher 
                      {% else %}
                      {{item['likes']}} people like this teacher 
                      {% endif %}
                      </span>
                    {% endif %}
                    {% if item['likes'] == 1 %}
                    <span id="likes_{{item['_id']}}">
                      {% if item['_id'] in student_tutor_like %}
                      You like this teacher 
                      {% else %}
                      {{item['likes']}} person likes this teacher 
                      {% endif %}
                      </span>
                    {% endif %}

                  </li>
                </ul>
                   

                   
                    {% if current_user.id %}
                    <ul class="list-inline down-ul">
                        <li>
                          {% if current_user.fb_id %}
                   <button id="associate_{{item['_id']}}" type="button" class="btn-u btn-u-sm" onclick="associate_tutor('{{item['_id']}}','{{current_user.fb_id}}')"  
                      {% if item['_id'] not in student_tutor_assoc %}
                      style="display:;"
                      {% else %}
                      style="display:none;"
                      {% endif %}
                      >I studied under this teacher</button>
                      
                      <span id="disassociate_{{item['_id']}}"
                       {% if item['_id'] in student_tutor_assoc %}
                      style="display:;"
                      {% else %}
                      style="display:none;"
                      {% endif %}
                     >
                      

                      
                      You studied under this tutor 

                      <button type="button" class="btn-u btn-u-dark btn-u-sm" onclick="disassociate_tutor('{{item['_id']}}','{{current_user.fb_id}}')">No</button>


                   
                   
                    </span>
                    {% endif %}

                     {% if current_user.id %}
                  <!-- <ul class="list-inline down-ul">
                    <li> -->
                    <button id="like_{{item['_id']}}" type="button" class="btn-u btn-u-sm" onclick="like_tutor('{{item['_id']}}', '{{current_user.id}}',{{item['likes']}})" 
                    {% if item['_id'] not in student_tutor_like %}
                    style="display:;"
                    {% else %}
                    style="display:none;"
                    {% endif %}
                    ><i class="fa fa-thumbs-up"></i> Like</button>

                    <button id="dislike_{{item['_id']}}" type="button" class="btn-u btn-u-sm btn-u-light-green" onclick="dislike_tutor('{{item['_id']}}', '{{current_user.id}}',{{item['likes']}})" 
                    {% if item['_id'] in student_tutor_like %}
                    style="display:;"
                    {% else %}
                    style="display:none;"
                    {% endif %}
                    ><i class="fa fa-thumbs-down"></i> Un-like</button>
            <!--      </li>
                </ul> -->
                    {% endif %}
                     
                    
                     

                    

                        </li>
                        <li>
                    <span  class="label label-default" style="display:none;cursor:pointer;" id="friend_{{item['_id']}}">
                     </span>
                   </li>
                       
                        
                    </ul>
                    {% endif %}


                </div>
                {% endfor %}
              </div>
                <hr>
                {% endfor %}
                <!-- Begin Inner Results -->

                

                <!-- Begin Inner Results -->
                
                <!-- Begin Inner Results -->

                <div class="margin-bottom-30"></div>

                <div class="text-left" id="page_selection">
                    
                </div>

                <div class="margin-bottom-30">
                  {% if results|length < 4 %}
                  <br><br><br><br><br><br><br><br>
                  {% endif %}
                </div>

            </div><!--/col-md-10-->
 
          </div>
        </div>
   <div class="row">
      
      <div class="col-lg-10 col-md-10">
        
   

              <div class="row">
                <div class="col-lg-5">
                  <div id="total_pages" style="display:none;">
                    {{total_pages}}
                  </div>
                  <div id="pagination_query" style="display:none">
                    {{query}}
                  </div>
                  <div id="classify" style="display:none" value="{{classify}}">
                    {{classify}}
                  </div>
                  <div id="page" style="display:none" value="{{page}}">
                    {{page}}
                  </div>
                  <div id="page_selection1">
                  </div>
              </div>  
            </div>
          </div>
        </div>

    
      

      <!-- Example row of columns -->
{% endblock %}

{% block javascript %}

<script>
$('.result').hover(function(){
  $(this).css('background-color','#eee');
},function(){
  $(this).css('background-color','white');
});
</script>   

<script>     
function options(subject)
{
  return ['check'];
  $.ajax({
  type: "GET",
  url: "/options?subject="+subject,
  
  
  success: function(data)
  {
    return data;
    
  },
  fail: function()
  {
    
    
  }
}).done(function( msg ) {
 // document.getElementById("user_tips").value="";
  //alert("Thanks for helping us improve!");
});
}

var subjects = new Bloodhound({
  datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
  queryTokenizer: Bloodhound.tokenizers.whitespace,
  
  remote: {
    url: '/options?subject=%QUERY',
    wildcard: '%QUERY'
  },
   prefetch : {
    url: '/options?subject='
   
  }
});

var suggestion="";
var classify="y";

$('.input-group #search').typeahead({
  hint: true,
  highlight: true,
  minLength: 1
}, {
  name: 'subjects',
  display: 'value',
  source: subjects
}).on('typeahead:select', function (obj, suggestion) {
  suggestion=suggestion['value'];
  classify="n";
  window.location='search?is_pre_filter=y&subject='+encodeURIComponent(suggestion); 
  
});




function like_tutor(tutor_id,student_id,likes){

  data={};
  data['tutor_id']=tutor_id;
  data['student_id']=student_id;
  
  likes=parseInt(likes);
  jQuery.ajax({
    url: '/like_student_tutor',
    data: data,
    type: 'POST',
    success: function(data)
    {
      if(data['result']=='success')
      {
        $('#like_'+tutor_id).css('display','none');
        $('#dislike_'+tutor_id).css('display','');
        if(likes+buffer[""+tutor_id]==0)
        {
          $('#like_section_'+tutor_id).css('display','');
          $('#likes_'+tutor_id).html('You like this teacher');
        }
        if(likes+buffer[""+tutor_id]==1)
        {
          $('#like_section_'+tutor_id).css('display','');
          $('#likes_'+tutor_id).html('You and '+'1 person like this teacher');
        }
        if(likes+buffer[""+tutor_id]>1)
        {
          $('#like_section_'+tutor_id).css('display','');
          $('#likes_'+tutor_id).html('You and '+(likes+buffer[""+tutor_id])+' people like this teacher');
        }
        buffer[""+tutor_id]=buffer[""+tutor_id]+1;

      }
    }

});
}

function dislike_tutor(tutor_id,student_id,likes){

  data={};
  data['tutor_id']=tutor_id;
  data['student_id']=student_id;
  likes=parseInt(likes);
  jQuery.ajax({
    url: '/dislike_student_tutor',
    data: data,
    type: 'POST',
    success: function(data)
    {
      if(data['result']=='success')
      {
        $('#dislike_'+tutor_id).css('display','none');
        $('#like_'+tutor_id).css('display','');
      }
      if(likes+buffer[""+tutor_id]<=1)
        {
          $('#like_section_'+tutor_id).css('display','none');
          
        }
      if(likes+buffer[""+tutor_id]==2)
        {
          $('#like_section_'+tutor_id).css('display','');
          $('#likes_'+tutor_id).html('1 person likes this teacher');
        }
      if(likes+buffer[""+tutor_id]>2)
        {
          $('#like_section_'+tutor_id).css('display','');
          if(buffer[""+tutor_id]>0)
          {
          
          $('#likes_'+tutor_id).html(likes+' people like this teacher');
        }
        else {
         $('#likes_'+tutor_id).html((likes-1)+' people like this teacher'); 
        }

        }
        buffer[""+tutor_id]=buffer[""+tutor_id]-1;
    }

});
}


function associate_tutor(tutor_id,student_id){

  data={};
  data['tutor_id']=tutor_id;
  data['student_id']=student_id;
  jQuery.ajax({
    url: '/associate_student_tutor',
    data: data,
    type: 'POST',
    success: function(data)
    {
      if(data['result']=='success')
      {
        $('#associate_'+tutor_id).css('display','none');
        $('#disassociate_'+tutor_id).css('display','');
      }
    }

});
}

function disassociate_tutor(tutor_id,student_id){

  data={};
  data['tutor_id']=tutor_id;
  data['student_id']=student_id;
  jQuery.ajax({
    url: '/disassociate_student_tutor',
    data: data,
    type: 'POST',
    success: function(data)
    {
      if(data['result']=='success')
      {
        $('#disassociate_'+tutor_id).css('display','none');
        $('#associate_'+tutor_id).css('display','');
      }
    }

});
}

function tutor(id){
  window.location='tutor?id='+id;
}

function search()
    {
        var name=document.getElementById("search");
        if(name==null || name.value.trim()=="")
          return;
        
          
          window.location='search?subject='+encodeURIComponent(name.value.trim());
        
    }


function custom_logic(login_status)
{
  //alert(login_status);
  utility(login_status);
}

function utility(login_status){

  
  if(login_status!='connected'){
    $('.associations').each(function(){
      $(this).css('display','none');
    });
  }
  else{
    friend_tutor();
  }

}


function friend_tutor()
{
  //alert('friend_tutor');
  var tutors=[]
  console.log($('.tutors').size());
  $('.tutors').each(function(){
    tutors.push($(this).attr('id'));
  });
  var friends=[]
   FB.api('/me/friends', function(response) {
    console.log(response);
    var ind=0;
    for(ind=0;ind<response['data'].length;ind++)
    {
      friends.push(response['data'][ind]['id']);
    }

    data={}
   data['tutors']=tutors;
   data['friends']=friends;
   console.log(data);
   jQuery.ajax({
    url: '/friend_tutor',
    data: data,
    type: 'POST',
    success: function(data)
    {
      if(data['result']=='success')
      {
        var ind=0;
        for(ind=0;ind<data['friend_tutor'].length;ind++)
        {
          $('#friend_'+data['friend_tutor'][ind]).text('Your friend has studied under this tutor');
          $('#friend_'+data['friend_tutor'][ind]).css('display','');
        }
      }
    }

});
  });
   

}


if(parseInt($('#total_pages').html().trim())>1)
{
$('#page_selection').bootpag({
  total: parseInt($('#total_pages').html().trim()),
  page: parseInt($('#page').html().trim()),
  leaps:false,
  maxVisible:5,
  next:'next',
  prev:'prev'
  //href:'/search?subject='+$('#pagination_query').html().trim()+'&classify='+$('#classify').html().trim()+"&page={% raw %}{{number}}{% endraw %}"
}).on("page",function(event,num){

   var url=window.location.href;
   var n=url.indexOf("page");
   if(n==-1){
   url=url+"&page="+num;
 }
 else{
  url=url.substring(0,n)+"&page="+num;
 }
   $('#filter_form').attr('action',url);
   get_filtered_results();
   //window.location='/search?subject='+$('#pagination_query').html().trim()+'&classify='+$('#classify').html().trim()+"&page="+num;
});
}

var selected_area=[];
var checkboxes_area=[];
var selected_subject=[];
var checkboxes_subject=[];
var selected_venue=[];
var checkboxes_venue=[];
var actual_tagged_subjects="{{actual_tagged_subjects}}";
var actual_tagged_areas="{{actual_tagged_areas}}";





function get_filtered_results(){

  //get list of checkboxes, get list of checkboxes selected
  //send list to backend
  //send post request to backend


  selected_area="";
  $('#area_outer input:checked').each(function() {
    selected_area=selected_area+$(this).attr('name')+"|";
});

  checkboxes_area="";
  $('.area_checkbox').each(function() {
    checkboxes_area=checkboxes_area+$(this).attr('name')+"|";
}); 



  selected_subject="";
  $('#subject_outer input:checked').each(function() {
    selected_subject=selected_subject+$(this).attr('name')+"|";
});

  checkboxes_subject="";
  $('.subject_checkbox').each(function() {
    checkboxes_subject=checkboxes_subject+$(this).attr('name')+"|";
});
selected_venue="";
  $('#venue_outer input:checked').each(function() {
    selected_venue=selected_venue+$(this).attr('name')+"|";
});

  checkboxes_venue="";
  $('.venue_checkbox').each(function() {
    checkboxes_venue=checkboxes_venue+$(this).attr('name')+"|";
}); 
 
  data={}
  data['areas_selected']=selected_area;
  data['areas_checkboxes']=checkboxes_area;
  data['subject_selected']=selected_subject;
  data['subject_checkboxes']=checkboxes_subject;
  data['venue_selected']=selected_venue;
  data['venue_checkboxes']=checkboxes_venue;

/*jQuery.ajax({
    url: window.location.href,
    data: data,
    type: 'POST',
    
    success: function(data)
    {
      if(data['result']=='success')
      {
        var ind=0;
        for(ind=0;ind<data['friend_tutor'].length;ind++)
        {
          $('#friend_'+data['friend_tutor'][ind]).text('Your friend has studied under this tutor');
          $('#friend_'+data['friend_tutor'][ind]).css('display','');
        }
      }
    }

});*/

$('#filter_form').submit();

}

function get_filtered_results_pre()
{

  var url=window.location.href;
  var n=url.indexOf("page");
   if(n==-1){
  
 }
 else{
  url=url.substring(0,n);
 }
  $('#filter_form').attr('action',url);
  get_filtered_results();
}

$('#filter_form').submit(function(){

  var input1 = $("<input>")
               .attr("type", "hidden")
               .attr("name", "areas_checkboxes").val(checkboxes_area);

  var input2 = $("<input>")
               .attr("type", "hidden")
               .attr("name", "areas_selected").val(selected_area);

  var input3 = $("<input>")
               .attr("type", "hidden")
               .attr("name", "subject_checkboxes").val(checkboxes_subject);

  var input4 = $("<input>")
               .attr("type", "hidden")
               .attr("name", "subject_selected").val(selected_subject);

  var input5 = $("<input>")
               .attr("type", "hidden")
               .attr("name", "venue_checkboxes").val(checkboxes_venue);

  var input6 = $("<input>")
               .attr("type", "hidden")
               .attr("name", "venue_selected").val(selected_venue);

  var input7 = $("<input>")
               .attr("type", "hidden")
               .attr("name", "actual_tagged_subjects").val(actual_tagged_subjects);

  var input8 = $("<input>")
               .attr("type", "hidden")
               .attr("name", "actual_tagged_areas").val(actual_tagged_areas);

  
  $('#filter_form').append(input1);
  $('#filter_form').append(input2);
  $('#filter_form').append(input3);
  $('#filter_form').append(input4);
  $('#filter_form').append(input5);
  $('#filter_form').append(input6);
  $('#filter_form').append(input7);
  $('#filter_form').append(input8);

});

function toggler(){

  if ($('#filter-options').hasClass('hidden-xs')==true)
  {
    $('#filter-options').removeClass('hidden-xs');
  }
  else{
    $('#filter-options').addClass('hidden-xs'); 
  }
}
</script>  
{% endblock %}



